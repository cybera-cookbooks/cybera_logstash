input {
  rabbitmq {
    ack => true
    host => 'localhost'
    port => <%= node[:logstash][:broker][:port] %>
    exchange => "logstash"
    user => "<%= node[:rabbitmq][:default_user] %>"
    password => "<%= node[:rabbitmq][:default_pass] %>"
    ssl => <%=  node[:logstash][:ssl][:enabled] %>
  }
}

filter {
  if [type] == "apache-access" {
    # apache-access logs
    grok {
      patterns_dir => "<%= @patterns_dir %>"
      match => [ "message", "%{APACHE_LMC_ACCESS_LOG}" ]
    }
    mutate {
      convert => [ "responsetime", "integer" ]
      convert => [ "bytes", "integer" ]
    }
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      remove_field => [ "timestamp" ]
    }
    geoip {
      add_tag => [ "geoip" ]
      source => "clientip"
    }

    # create coords array with long and lat
    mutate {
      add_field => [ "coords", "%{[geoip][longitude]}",
                     "tmplat", "%{[geoip][latitude]}" ]
      merge => [ "coords", "tmplat" ]
      remove_field => "tmplat"
      convert => [ "coords", "float" ]
    }

  }
}


output {
  stdout { debug => true }

  elasticsearch {
    host => "localhost"
  }
}