input {
  rabbitmq {
    ack => true
    host => 'localhost'
    port => 5671
    exchange => "logstash"
    user => "guest"
    password => "guest"
    ssl => true
  }
}

filter {
  if [type] == "apache-access" {
    # apache-access logs
    grok {
      patterns_dir => "<%= @patterns_dir %>"
      match => [ "message", "%{APACHE_LMC_ACCESS_LOG}" ]
    }
    mutate {
      convert => [ "responsetime", "integer" ]
      convert => [ "bytes", "integer" ]
    }
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      remove_field => [ "timestamp" ]
    }
    geoip {
      add_tag => [ "geoip" ]
      source => "clientip"
    }

    # create coords array with long and lat
    mutate {
      add_field => [ "coords", "%{[geoip][longitude]}",
                     "tmplat", "%{[geoip][latitude]}" ]
      merge => [ "coords", "tmplat" ]
      remove_field => "tmplat"
      convert => [ "coords", "float" ]
    }

  }
}


output {
  stdout { debug => true }

  elasticsearch {
    host => "localhost"
  }
}