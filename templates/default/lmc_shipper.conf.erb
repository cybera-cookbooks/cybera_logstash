input {
  file {
    type => "apache-access"
    path => ["/var/log/apache2/access.log*"]
    exclude => ["*.gz"]
  }
  file {
    type => "postgresql"
    path => ["/var/log/postgresql/postgresql-9.1-main.log*"]
    exclude => ["*.gz"]
    codec => multiline {
      pattern => "(DETAIL:)|(STATEMENT:)"
      what => "previous"
    }
  }
}

filter {
  mutate {
    add_field => ["institution", "<%= node[:institution] %>"]
  }
  mutate {
    update => ["host", "%{institution}-%{host}"]
  }
}

output {
  <% if node[:logstash][:broker][:type] == "rabbitmq" %>
  # Broker output
  rabbitmq {
    host => "<%= node[:logstash][:broker][:ipaddress] %>"
    port => <%= node[:logstash][:broker][:port] %>
    exchange => "logstash"
    user => "<%= node[:rabbitmq][:default_user] %>"
    password => "<%= node[:rabbitmq][:default_pass] %>"
    exchange_type => "fanout"
    ssl => <%=  node[:logstash][:ssl][:enabled] %>
  }
  <% end %>
}